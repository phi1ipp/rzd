var CabGlb=function(){var x=1000;var h=0;function j(G){var H=lang(["TicketStatus",G]);return H||G}function m(I){var H,G={};for(H in I){if("value" in I[H]){G[I[H].name]=I[H].value}}return G}function p(){$("#CabBox .cab-status-but").unbind().click(function(){return F.askStatus(this)})}function q(){if(!("g_linkFlag" in window)){return}var R=0,M=$("#NewsBox"),V=1,G=1,J=1,N,T,K,S=0;function P(ac,Y){S=0;var ab=new AsyncRequest(ac);ab.request({},aa,X);var W=M.find(".j-content").hide(),Z=M.find(".j-wait").show();function aa(ad){S=ad.Text;V=+ad.FlagImg;N=ad.PrevPage;G=(typeof N==="string")&&N;T=ad.NextPage;J=(typeof T==="string")&&T;K=ad.UNIQ_MARK;Z.hide();W.show();W.find(".j-hdr").html(ad.Name);W.find(".j-img").css({"float":V?"left":"right","margin-right":V?"20px":0,"margin-left":V?0:"20px"});W.find(".j-text").html(S);W.find(".j-img img").attr("src",ad.ImgNews).toggle(!!ad.ImgNews);enableElem(W.find(".j-prev"),G);enableElem(W.find(".j-next"),J);if(Y){Y()}}function X(){if(M.is(":visible")){L()}}}function L(){$(window).unbind("click",L).unbind("keyup",O);M.fadeOut(500,function(){M.hide()});return false}function O(W){if(W.which==27){L()}}function U(){if(M.is(":visible")||!S){return}var W=$(window).height(),ac=$(window).width();var Z=0.25,X=0.2,ab=0.6,Y=window.NewsBoxProps;if(Y){Z=Y.horizField*0.01;X=Y.topOffset*0.01;ab=Y.height*0.01}var aa=M.outerWidth(),ad=M.outerHeight();M.css({top:(W-ad)/2,left:(ac-aa)/2});M.fadeIn(500);$(window).click(L).keyup(O);if(!R){M.click(function(ae){ae.stopPropagation()});M.find(".j-close").click(L);M.find(".j-prev").click(function(){P(N);return false})}M.find(".j-next").click(function(){P(T);return false});R=1}var Q=1;$(document).on("click","a[href$=new-banner]",function(){if(Q){I()}U();return false});var H=0;if("g_linkFlag" in window){$.get(g_linkFlag,function(X){H=X.IdUser;var Y=+X.FPC_MESSAGE_NO_SHOW_FLAG,W=+X.NOT_SHOWN_NEWS_FLAG;M.find(".j-checkbox :checkbox").prop("checked",Y);if(W&&!Y){I()}})}function I(){Q=0;P(g_linkNews,function(){U()})}M.find(".j-save").click(function(){var W=M.find(".j-checkbox :checkbox").prop("checked")?1:0;$.get(g_linksCheck+encodeURIComponent(K),{FPC_MESSAGE_NO_SHOW_FLAG:W,ID:H},function(X){K=X.UNIQ_MARK})})}function c(I,L,K,G,H){if(window.pgAddr){if(pgAddr.log!="null"){L.log=pgAddr.log;L.nopack=1}if(pgAddr.err!="null"){L.err=pgAddr.err}}function J(){$.ajax({url:I,type:"get",dataType:"json",data:L,success:function(N,M,O){if("error" in N){if(G){G()}if(H){H(N.error,N)}}else{if(N.result=="RID"){L.rid=N.RID;setTimeout(J,x)}else{if(G){G()}K(N,M,O)}}},error:function(N,M,O){if(G){G()}if(H){H(lang("Server Error"))}}})}J()}var a={};function A(G){if(pgAddr.log!="null"){G+="&log="+encodeURIComponent(pgAddr.log)}if(pgAddr.err!="null"){G+="&err="+encodeURIComponent(pgAddr.err)}return G}function f(I){this.status="Ask";for(var H in I){this[H]=I[H]}this.finalSt="status" in I;var G="TmBlankTicketLink";if(this.status.indexOf("REFUND")>=0){G="TmRefundTicketLink"}this.draw=function(P){var N,M=!this.bInspector,J=$(applyTempl("TmTicket",$.extend(this,{index:P,Cost:moneyFmt(this.cost),StatusCtrl:this.statusCtrl(),RefundButton:M?tmRefundButton:"",BlankLink:(this.old==1||this.bRefundEx)?"":applyTempl(G,{url:this.blankURL()})})));if(this.insurances){var K=$(".j-insurance-list",J);for(N in this.insurances){var L=this.insurances[N],O=$(applyTempl(L.Refunded?"TmInsurRefunded":"TmInsuranceItem",L)).appendTo(K);O.find("a[href=#ins-refund]").click(function(T){if(confirm("Осуществить возврат страховки?")){var Q=new n(this),U={ORDER_ID:Q.order.N,ticket_id:Q.ticket.n,ticketNumber:Q.ticket.id,passengerId:L.passId},R=$(".j-status",J).html(applyTempl("TmInsuranceRefundWait",{})),S=new AsyncRequest(pgAddr.InsuranceRefund);paramErrLog(U);O.hide();S.request(U,function(V){R.hide()},function(V){O.show();R.html(applyTempl("TmInsuranceRefundError",{msg:V}))})}return endClick(T)});$("#ETB_ORDERS_ENS_RETURN").show()}}return J};this.blankURL=function(){if(!("BlankStandardPers" in pgAddr)){return"#error"}return A(applyTemplS(pgAddr.BlankStandardPers,this))};this.statusCtrl=function(){var K=$.extend({Status:j(this.status)},a,this);var J="";if(!this.old&&!this.finalSt&&!this.bInspector){J=applyTempl("TStatus_"+this.status,K)}if(J==""){J=applyTempl("TStatus_Std",K)}return J}}function n(H){var I=$(H).parents(".cab-pass");var G=I.parents(".cab-order");this.nSlot=G.find("input[name=slot]").val();this.slot=F.G.slots[this.nSlot];this.nOrder=G.find("input[name=index]").val();this.order=this.slot.lst[this.nOrder];this.nTicket=I.find(":hidden").val();this.ticket=this.order.lst[this.nTicket];this.toString=function(){return this.nSlot+"/"+this.nOrder+"/"+this.nTicket}}function w(H){var G=this.orderBox=$(H).parents(".cab-order");this.nSlot=G.find("input[name=slot]").val();this.nOrder=G.find("input[name=index]").val();this.slot=F.G.slots[this.nSlot];this.order=this.slot.lst[this.nOrder]}function y(K,J,I){K.lst=[];var H,G;for(H in J){if(H!="lst"){K[H]=J[H]}else{for(G in J.lst){K.lst[G]=new I(J.lst[G])}}}}function v(I){this.bExpand=false;var H,G;y(this,I,f);this.PN=0;if(!this.old){this.old=0}for(H in this.lst){G=this.lst[H];if(G.cost!=0){this.PN++}G.old=this.old;G.order_id=this.N}this.Cost=moneyFmt(this.cost);if(!this.status){this.status="Ask"}this.draw=function(N,M){var L=$(applyTempl("TmOrder",$.extend(this,{slot:N,index:M,loto:applyTempl("TmLoto",{}),switcher:C(this),paneStyle:this.bExpand?"":"display:none",StatusCtrl:this.inactive?"":this.statusCtrl(),BlankLink:applyTempl(this.lst.length==1?"TmBlankTicketLink":"TmBlankOrderLink",{url:this.blankURL()})}))),K=$(".j-pass-list",L);for(var J in this.lst){this.lst[J].bInspector=this.bInspector;K.append(this.lst[J].draw(J))}return L};this.blankURL=function(){var K="BlankStandard";if(this.old==1){K="OldBlank"}var J=applyTemplS(pgAddr[K],this);return A(J)};this.statusCtrl=function(){return applyTempl(this.status+"Status",{})};this.updateStatus=function(M,O){var K=this;K.status="Ext";O.find(".status-ctrl").html(this.statusCtrl());var N,L,S,J,P=O.find(".status");for(N in M.lst){S=M.lst[N];J=S.n;L=this.lst.length;while(--L>=0&&this.lst[L].n!=J){}if(L<0){continue}this.lst[L].status=S.status;$(P[L]).html(K.lst[L].statusCtrl())}if(this.old){var R=applyTempl("OldOrder_"+K.lst[0].status,a);O.find(".old-box").html(R)}var Q=O.find(".cab-switcher")[0];if(!E.call(Q)){s.call(Q)}this.food=K.food;if(this.food&&"FoodSelector" in window){O.find(".j-food-box").each(function(){var W,aa=$(this).empty(),Y=aa.parents(".cab-pass"),X=Y.find(":hidden").val(),Z=K.lst[X],U=$(applyTempl("TmFoodBox",{number:X+1})).appendTo(aa).find(".j-food-list"),V=Z.place.split(",");for(W in V){T(W)}function T(ad){var af=$(applyTempl("TmFoodElem",{place:V[ad]})).appendTo(U).find(".j-food-elem");var ac,ah=0,ag="Unknown",ae=K.foodList;if(Z.foodChoice){ah=Z.foodChoice[V[ad]]}if(ah){ac=0;while(ac<ae.length&&ae[ac].foodType!=ah){ac++}if(ac<ae.length){ag=ae[ac].name}}var ab={type:ah,name:ag,finalTime:K.foodFinal,lst:K.foodList,params:{orderId:K.N,ticketNumber:Z.id,passengerId:Z.passId.split(",")[0],seat:V[ad]},onChanged:function(){Z.foodChoice[V[ad]]=ab.type}};FoodSelector.popupItem(af,ab)}})}};this.toggle=r}function r(H,I){this.bExpand=H;if(I){for(var G in this.lst){this.lst[G].bExpand=H}}}function l(K){this.bExpand=false;var H,J,I,G;y(this,K,v);this.cost=0;var L=[];for(H in this.lst){J=this.lst[H];I=J.super0||J.station0;G=J.super1||J.station1;if(L.length==0||L[L.length-1]!=I){L.push(I)}L.push(G);this.cost+=J.cost;J.bInspector=this.bInspector}this.Cost=moneyFmt(this.cost);this.route=L.join(" - ");J=this.lst[0];this.date=J.date0;this.time=J.time0;this.draw=function(P){var M,O="";var N=$(applyTempl("TmSlot"+F.mode,$.extend(this,{index:P,paneStyle:this.bExpand?"":"display:none",switcher:C(this)})));for(M in this.lst){$(".j-order-list",N).append(this.lst[M].draw(P,M))}return N};this.toggle=r}function B(G){try{return b.call(this,G)}catch(H){showError(H)}return false}function b(V){var O=$(this);if(O.hasClass("disabled")){return false}var Q=O.addClass("disabled").offset();var U=$(applyTempl("RefundBoxTempl",{})).appendTo("body").hide();U.fadeIn("fast").click(function(L){L.stopPropagation();return false}).css({left:Q.left+$(this).outerWidth()-U.outerWidth(),top:Q.top+$(this).outerHeight()}).find(".Cancel").click(I);var X=new n(this);var W=X.order,R=X.ticket,S,M,H=0;if((W.vip||W.fullCupe)&&W.nPayed!=1){U.find(".problem").show().html(applyTempl("TmCantRefundVip",{}));return}if(X.ticket.tariffId=="Obr"){var K,J=0,T=X.slot.lst;while(J!=T.length&&!H){S=T[J++];if(S==W){continue}K=S.lst.length-1;while(K>=0){M=S.lst[K];if(M.tariffId=="Obr"&&M.name==R.name&&M.doc==R.doc){H=1;break}K--}}}function I(){O.removeClass("disabled");U.fadeOut("slow",function(){U.remove()});$("body").unbind("click",I).unbind("keypress",P)}function P(L){if(L.which==27){I()}}$("body").click(I).keydown(P).bind("dlgClose",function(L){I()});if(H){G()}else{N()}function G(){U.find(".dblInfo").show().html(applyTempl("TmDblInfo",$.extend({},S,M)));U.find(".OK").show().click(aa);var Y=[{o:W,t:R,no:X.nOrder,nt:X.nTicket},{o:S,t:M,no:J-1,nt:K}],L=2,ab=0;function aa(){var ac=$(applyTempl("TmDblRefundWait",{}));U.find(".dblInfo").empty().append(ac);U.find(".OK").unbind().hide();for(var ad in Y){ae(ad)}function ae(af){var ai,ag=Y[af];ac.find(".dbl-ref-list").append(ai=$(applyTempl("TmDblRefundWaitItem",$.extend({rindex:+af+1},ag.o,ag.t))));var ah={ORDER_ID:ag.o.N,ticket_id:ag.t.n,action:"PREVIEW"};function aj(ak,al){ai.find(".dbl-ref-item").html(applyTempl(ak,al))}c(pgAddr.Refund,ah,function(ak){aj("TmDblRefundCost",{cost:moneyFmt(ak.sum)});if(++ab==L){U.find(".OK").show().click(Z)}},function(){},function(ak){aj("TmDblRefundErr",{message:ak})})}}function Z(){I();Y[0].el=O.parents(".status");$(".cab-order").each(function(){var ae=$("input[name=slot]",this).val(),af=$("input[name=index]",this).val();if(ae==X.nSlot&&+af==Y[1].no){Y[1].el=$(".cab-pass",this).eq(K).find(".status");return false}});for(var ac in Y){ad(ac)}function ad(ae){var af=Y[ae];af.el.html(applyTempl("TmRefundRequest",{}));var ag={ORDER_ID:af.o.N,ticket_id:af.t.n,action:"REFUND"};function ah(aj,ai){af.el.html(applyTempl(aj,ai))}c(pgAddr.Refund,ag,function(ai){ah("TStatus_Std",{Status:j("REFUNDED")})},false,function(ai){ah("TmRefundError",{message:ai})})}}}function N(){U.find(".wait").show();U.find(".OK").click(L);var Y={ORDER_ID:W.N,ticket_id:R.n,action:"PREVIEW"};c(pgAddr.Refund,Y,function(Z){U.find(".OK,.confirm").show();U.find(".jAmount1").html(applyTempl("TmAmount1",$.extend({summa:moneyFmt(Z.sum)},Z)))},function(){U.find(".wait").hide()},function(ac,ab){var aa=U.find(".problem").show();aa.find(".msg").text(ac);var Z=aa.find(".info");if(ab.info){Z.show().text(ab.info)}else{Z.hide()}});function L(){I();var Z=$(applyTempl("TmRefundRequest",{}));O.after(Z).hide();Y.action="REFUND";delete Y.rid;c(pgAddr.Refund,Y,function(aa){Z.parents(".status").html(applyTempl("TStatus_Std",{Status:j("REFUNDED")}))},false,function(aa){Z.html(applyTempl("TmRefundError",{message:aa}))});return false}}return false}function e(){var H,K={},I=$(this).parents(".cab-pass"),J=$(this).parents(".cab-order");if(I.length==0){H=new w(this)}else{H=new n(this);K.ticket_id=H.ticket.n}K.ORDER_ID=H.order.N;K.action=$(this).hasClass("btn-reg-cancel")?"UNREGISTER":"REGISTER";var G=$(this).hide().parent();G.find(".wait").show();G.find(".problem").remove();c(pgAddr.Registration,K,function(L){H.order.updateStatus(L,J)},false,function(L){G.find(".btn-reg,.btn-reg-cancel,.problem").show();G.find(".wait").hide();G.append(applyTempl("ProblemBox",{msg:L}))});return false}var u=0;function k(H){u+=H;var G=true;if(u==0){G=$(".ticket-var :checkbox:checked").length==0}$("#submitElReg").toggleClass("disabled",G).toggle($(".ticket-var :checkbox").length!=0)}function t(G,J){var H={ORDER_ID:G,action:"REGISTER"};if(J){H.ticket_id=J}k(1);function I(){k(-1)}c(pgAddr.Registration,H,function(M){for(var L in M.lst){var K=M.lst[L];$("#tvar-"+K.n).html(applyTempl(K.status=="REGISTERED"?"TmREGISTERED":"TmElse",{status:j(K.status)}))}I()},false,function(L){var K=J?"#tvar-"+J:"#order-"+G+" .ticket-var";$(K).html(applyTempl("TmError",{msg:L}));I()})}function i(){var H=new w(this).order;var G=pgAddr.Loto+"?"+$.param({ORDER_ID:H.id,DATE:H.date0,TRAIN:H.train,COACH:H.car});$("#zdLotoURL").attr("href",G);$("#zdLotoBanner").modal({onClose:function(I){I.container.fadeOut(100,function(){I.overlay.fadeOut(200,function(){$.modal.close()})})}});return false}var F={mode:1,G:null,onInit:function(){a.ERBoxCancel=applyTempl("ERBoxCancel",{});a.ERBox=applyTempl("ERBox",{});tmRefundButton=applyTempl("TmRefundButton",{});function G(J){$("#CabBox .cab-pane").toggle(J)}$("#ExpandAll").click(function(){G(true)});$("#CollapseAll").click(function(){G(false)});this.modeButtons();$(".cab-mode-btn").click(function(){F.mode=+this.href.substring(this.href.length-1);F.modeButtons();$("#CabBox").empty();F.draw();return false});q();function I(){$(".cab-slot:last").css("border-bottom","2px solid #007");params=m($("#Filter form").serializeArray());params.page=h+1;$("#WaitMsg").show();$("#FirstError,#ToolBar,#MoreOwner").hide();c(pgAddr.JourneyList,params,function(J){$("#WaitMsg").hide();$("#ToolBar").show();h++;F.onUpdate(J);F.showMoreButton()},false,function(K,J){if(J&&J.info){K+="<pre>"+J.info+"</pre>"}$("#FirstError").show();$("#WaitMsg").hide();$("#FirstErrorMsg").html(K)});return false}$("#FirstErrorRefresh").click(I);I();function H(K){var J=[];$("#Filter input[name^=date]").each(function(){var L=$(this).val();if(L==""){return}var M=new TicketDate(L);if(!M.isOk()){J.push(this.name=="date0"?"Ошибка в начальной дате":"Ошибка в конечной дате")}else{if(K){$(this).val(M.toString())}}});if(J.length==0){return false}return J.join("<br>")}$(document).on("click",".btn-refund",B);$(document).on("click",".btn-reg,.btn-reg-cancel",e);$("#Filter form").submit(function(){var J=H(true);if(J){alert(J);return false}h=0;F.G.slots.length=0;$("#CabBox").empty();I();return false});$.datepicker._gotoToday=function(M){var L=$(M);var K=this._getInst(L[0]);if(this._get(K,"gotoCurrent")&&K.currentDay){K.selectedDay=K.currentDay;K.drawMonth=K.selectedMonth=K.currentMonth;K.drawYear=K.selectedYear=K.currentYear}else{var J=new Date();K.selectedDay=J.getDate();K.drawMonth=K.selectedMonth=J.getMonth();K.drawYear=K.selectedYear=J.getFullYear();this._setDateDatepicker(L,J);this._selectDate(M,this._getDateDatepicker(L))}this._notifyChange(K);this._adjustDate(L)};$("#Filter input[name^=date]").datepicker(datePickerLoc({buttonImage:"/images/calendar.gif",buttonImageOnly:true,showOn:"both",buttonText:"",showAnim:"",buttonImageOnly:true,currentText:"Сегодня",gotoCurrent:false,showButtonPanel:true}));$("#MoreButton").click(I)},modeButtons:function(){for(var G=0;G<2;G++){$("a[href=#SlotMode"+G+"]").toggleClass("current",G==this.mode)}},onUpdate:function(J){if(h==1){this.G={slots:[]}}var H,I,G=this.G.slots;var K=G.length;for(H in J){if(H!="slots"){this.G[H]=J[H]}else{for(I in J.slots){G.push(new l(J.slots[I]))}}}if(G.length>0){G[0].toggle(true,true)}this.draw(K)},showMoreButton:function(){$("#MoreOwner").toggle(F.G.slots.length<F.G.totalCount)},draw:function(G){var H="";if(!G){G=0}if(this.G.slots){var I=this.G.slots;while(G<I.length){$(I[G].draw(G)).appendTo("#CabBox");G++}}if(I.length==0){$("#CabBox").html(applyTempl("EmptyList",{}))}$("#CabBox").find(".cab-switcher").unbind().click(d).bind("togglePane",s);$("#CabBox a.loto-ref").click(i);$("#CabBox .cab-order:odd").addClass("odd");$("#CabBox .cab-order:even").addClass("even");p()},askStatus:function(K){try{var I=new w(K);var M=I.orderBox.find(".status-ctrl").html(applyTempl("WaitStatus",{}));I.orderBox.find(".status").html(applyTempl("TStatus_Ask",{}));var G=[],H=I.order.lst;for(var J in H){if(H[J].n){G.push(H[J].n)}}var L={ORDER_ID:I.order.N};if(G.length>0){L.tickets=G.join(",")}c(pgAddr.ActualStatus,L,function(O){I.order.updateStatus(O,I.orderBox);p()},false,function(O){M.html(applyTempl("StatusError",{msg:O}))});p();return false}catch(N){showError(N)}}};function C(G){return applyTempl("Switcher",{cont:applyTempl(G.bExpand?"BtnOpen":"BtnClosed",{})})}function d(G){G.preventDefault();$(this).trigger("togglePane");return false}function g(G){return $(G).parents(".cab-owner:first").find(".cab-pane:first")}function E(){return g(this).is(":visible")}function s(){if(!$(this).hasClass("disabled")){var G=$(this).addClass("disabled");var I=g(this);var H=(!I.is(":visible"))?{t:"BtnOpen",f:"slideDown"}:{t:"BtnClosed",f:"slideUp"};I[H.f](300,function(){G.html(applyTempl(H.t),{}).removeClass("disabled")})}}function z(I,G){function J(K){$(I).html(K)}var H=applyTempl("WaitStatus",{});if(H!=""){J(H)}c(G,{},function(O){J(j(O.lst[0].status));for(var N in O.lst){var M=O.lst[N];var K=$("#tstatus-"+M.n).html(M.name_ru+"<br/>"+M.name_en).parents(".order-cont");var P=M.status;var Q=$("#ETB_"+P);if(Q.length==1){var L=$("#code2D-"+M.n).text();$("#CouponStatus-"+M.n).html(applyTempl("ETB_"+P,{code2d:L}))}else{$("#CouponStatus-"+M.n).empty()}$("#status-"+M.status+"-"+M.n).show();if(/^PAID/.test(P)){$(".j-warning-box",K).show()}}},false,function(K){J("Возникла проблема: "+K)})}function o(G){return G.id.split("-")[1]}function D(){var M,S,L,R,I,J,H,N,Q,T,O,G,K,P=0;for(S in g_foodData){M=g_foodData[S];L=M.tickets;O=M.lst;if(!O||!O.length){continue}P=1;for(I in L){J=$("#FoodBox_"+I);N=L[I];for(T in N){H=N[T];K=$(applyTempl("TmFoodElem",{place:H.params.seat})).appendTo(J);FoodSelector.popupItem($(".j-food-elem",K),{type:H.curSel,name:H.curName,finalTime:M.foodFinal,lst:O,params:H.params})}}}$("#FoodMsg").toggle(!!P)}return{onInit:function(){F.onInit()},newsBoxSystem:q,askStatus:z,primaryReg:function(){if($("#submitElReg").hasClass("disabled")){return false}$(".order-box").each(function(){var H=o(this);var I=$(".ticket-var",this);var J=$(":checkbox:checked",this);if(J.length==0){return}var G=applyTempl("WaitER",{});if(I.length==J.length){I.html(G);t(H)}else{J.each(function(){var K=$(this).parents(".ticket-var");K.html(G);t(H,o(K[0]))})}});return false},primaryAsk:function(){$(".order-box").each(function(){var G=o(this),K=[];$(".ticket-var",this).each(function(){K.push(o(this))});$(".refresh-status-but").click(H);var L={ORDER_ID:G};function J(){$(".ticket-var :checkbox").unbind().click(I);I()}function I(){k(0)}D();function H(){k(1);$("#order-"+G).find(".refresh-status-box").hide().end().find(".ticket-var").html(applyTempl("WaitStatus",{}));c(pgAddr.ActualStatus,L,function(O){var Q=false;for(var N in O.lst){var M=O.lst[N];var R=$("<span/>").html(applyTempl(M.status=="PAID"?"TmPAID":"TmElse",{status:j(M.status)}));var P=$("#tvar-"+M.n).empty().append(R);if(M.status.indexOf("ON_")==0){Q=true;P.prepend('<img src="/images/ajax-loader-arr.gif" />')}}k(-1);J();if(Q){setTimeout(H,2000)}},false,function(N){$("#order-"+G+" .refresh-status-box").show();for(var M in K){$("#tvar-"+K[M]).html(applyTempl("TmError",{msg:N}))}k(-1);J()});return false}H()})}}}();